<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Device Detective</title>
        <link rel="stylesheet" href="../styles.css" />
        <style>
            /* ── START SCREEN ────────────────────────── */
            #start-screen {
                gap: 20px;
            }

            .wordmark {
                font-size: clamp(2.6rem, 8vw, 4rem);
                font-weight: 800;
                letter-spacing: -1px;
                color: var(--text);
            }
            .wordmark span {
                color: var(--accent);
            }

            .back-btn {
                position: absolute;
                top: 20px;
                left: 20px;
                font-size: 1.2rem;
                color: white;
                text-decoration: none;
                z-index: 100;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                font-weight: 600;
                transition: opacity 0.15s;
            }
            .back-btn:hover {
                opacity: 0.7;
            }

            .hs-row {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .hs-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 10px 18px;
                text-align: center;
                min-width: 130px;
            }
            .hs-card .hs-mode {
                font-size: 0.68rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 2px;
            }
            .hs-card .hs-val {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--accent);
            }

            .mode-grid {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
                max-width: 700px;
                width: 100%;
            }
            .mode-card {
                flex: 1;
                min-width: 150px;
                max-width: 220px;
                background: var(--surface);
                border: 2px solid var(--border);
                border-radius: 4px;
                padding: 16px 18px;
                cursor: pointer;
                transition:
                    border-color 0.15s,
                    background 0.15s;
                text-align: center;
            }
            .mode-card:hover {
                border-color: var(--text3);
                background: #202020;
            }
            .mode-card.selected {
                border-color: var(--accent);
                background: #1e1e2e;
            }
            .mode-title {
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text);
            }

            .filter-box {
                max-width: 700px;
                width: 100%;
                max-height: 30vh;
                overflow-y: auto;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 14px 18px;
            }
            .filter-label {
                font-size: 0.68rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 10px;
            }
            .chips {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            .chip {
                padding: 5px 12px;
                border-radius: 3px;
                border: 1px solid var(--border);
                background: transparent;
                font-size: 0.74rem;
                cursor: pointer;
                color: var(--text2);
                transition: all 0.15s;
            }
            .chip:hover {
                border-color: var(--text2);
                color: var(--text);
            }
            .chip.on {
                background: rgba(176, 173, 255, 0.12);
                border-color: var(--accent);
                color: var(--accent);
            }

            /* ── GAME SCREEN ─────────────────────────── */
            #game-screen {
                padding: 0;
                justify-content: flex-start;
                overflow: hidden;
            }

            .game-top {
                width: 100%;
                flex-shrink: 0;
                background: var(--surface);
                border-bottom: 1px solid var(--border);
                padding: 10px 20px 0;
                display: flex;
                flex-direction: column;
                gap: 6px;
                position: relative;
                z-index: 20;
            }
            .game-hud {
                display: flex;
                align-items: center;
                gap: 14px;
                flex-wrap: wrap;
            }

            .lives {
                display: flex;
                gap: 5px;
            }
            .heart {
                font-size: 1.2rem;
                transition: opacity 0.3s;
            }
            .heart.lost {
                opacity: 0.2;
            }

            .hud-group {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .hud-lbl {
                font-size: 0.6rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }
            .hud-val {
                font-size: 1.2rem;
                font-weight: 700;
            }
            .hud-val.c-score {
                color: var(--accent);
            }
            .hud-val.c-level {
                color: var(--text2);
            }

            .streak-badge {
                padding: 3px 12px;
                border-radius: 3px;
                font-size: 0.82rem;
                font-weight: 700;
                border: 1px solid var(--yellow);
                color: var(--yellow);
                background: rgba(201, 146, 42, 0.08);
            }
            .streak-badge.fire {
                border-color: var(--orange);
                color: var(--orange);
                background: rgba(219, 109, 40, 0.12);
                animation: fpulse 0.6s ease-in-out infinite alternate;
            }

            .ml-auto {
                margin-left: auto;
            }

            .time-track {
                height: 4px;
                background: var(--border2);
                border-radius: 2px;
                overflow: hidden;
            }
            .time-fill {
                height: 100%;
                border-radius: 2px;
                transition:
                    width 0.1s linear,
                    background 0.4s;
                background: var(--green);
            }

            .xp-track {
                height: 2px;
                background: var(--border2);
                border-radius: 1px;
                overflow: hidden;
                margin-top: 2px;
            }
            .xp-fill {
                height: 100%;
                border-radius: 1px;
                background: var(--purple);
                transition: width 0.4s ease;
            }
            .xp-lbl {
                font-size: 0.6rem;
                color: var(--text3);
                margin-top: 1px;
                padding-bottom: 6px;
            }

            /* ── QUESTION AREA ───────────────────────── */
            .game-body {
                flex: 1;
                width: 100%;
                overflow-y: auto;
                padding: 16px 20px 20px;
                display: flex;
                flex-direction: column;
                gap: 14px;
                max-width: 800px;
                margin: 0 auto;
                align-self: stretch;
            }
            .game-body-wrap {
                flex: 1;
                width: 100%;
                overflow-y: auto;
                display: flex;
                justify-content: center;
            }

            .q-meta {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
            }
            .tag {
                padding: 3px 10px;
                border-radius: 3px;
                font-size: 0.68rem;
                letter-spacing: 0.06em;
                border: 1px solid;
            }
            .tag-mode {
                border-color: rgba(176, 173, 255, 0.35);
                color: var(--accent);
                background: rgba(176, 173, 255, 0.06);
            }
            .tag-topic {
                border-color: var(--border);
                color: var(--text2);
                background: transparent;
            }
            .q-num {
                font-size: 0.68rem;
                color: var(--text3);
                margin-left: auto;
            }

            .question-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 22px 22px 18px;
                position: relative;
            }
            .q-prompt {
                font-size: 0.72rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 12px;
            }

            /* ── Excerpt display ─────────────────────── */
            .excerpt-display {
                font-size: clamp(1rem, 2.5vw, 1.25rem);
                line-height: 1.75;
                color: var(--text);
                font-style: italic;
            }
            .excerpt-hl {
                color: var(--accent);
                font-weight: 700;
                font-style: normal;
                border-bottom: 2px solid var(--accent);
                padding-bottom: 1px;
            }
            .device-name {
                font-size: 1.15rem;
                font-weight: 700;
                color: var(--text);
            }
            .device-def {
                font-size: 0.82rem;
                color: var(--text3);
                margin-top: 6px;
                line-height: 1.55;
            }
            .multi-hint {
                margin-top: 10px;
                font-size: 0.8rem;
                color: var(--text3);
                font-style: italic;
            }

            /* ── OPTIONS ─────────────────────────────── */
            .options-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            @media (max-width: 520px) {
                .options-grid {
                    grid-template-columns: 1fr;
                }
            }

            .opt {
                padding: 14px 16px;
                border-radius: 4px;
                border: 1px solid var(--border);
                background: var(--surface);
                color: var(--text);
                font-size: 0.9rem;
                font-family: inherit;
                cursor: pointer;
                text-align: left;
                line-height: 1.5;
                transition:
                    border-color 0.12s,
                    background 0.12s,
                    transform 0.1s;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                overflow: hidden;
            }
            .opt:hover:not(:disabled) {
                border-color: var(--accent);
                background: #1e1e2e;
                transform: translateY(-1px);
            }
            .opt:active:not(:disabled) {
                transform: none;
            }
            .opt:disabled {
                cursor: default;
            }
            .opt.correct {
                border-color: var(--green) !important;
                background: rgba(76, 175, 110, 0.1) !important;
                color: var(--green);
            }
            .opt.wrong {
                border-color: var(--red) !important;
                background: rgba(224, 82, 82, 0.08) !important;
                color: var(--red);
            }
            .opt.picked {
                border-color: var(--accent);
                background: rgba(176, 173, 255, 0.1);
            }

            .opt-letter {
                width: 22px;
                height: 22px;
                border-radius: 3px;
                background: var(--border2);
                color: var(--text3);
                font-size: 0.72rem;
                font-weight: 700;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                margin-top: 1px;
            }
            .opt-body {
                flex: 1;
                overflow: hidden;
            }
            .opt-excerpt {
                font-size: 0.78rem;
                color: var(--text3);
                margin-top: 4px;
                font-style: italic;
                line-height: 1.5;
            }

            .submit-btn {
                align-self: center;
                padding: 11px 36px;
                background: var(--accent);
                color: #0c0c18;
                border: none;
                border-radius: 3px;
                font-size: 0.9rem;
                font-weight: 700;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                cursor: pointer;
                display: none;
                transition: opacity 0.15s;
            }
            .submit-btn:hover {
                opacity: 0.85;
            }

            /* ── GAME OVER SCREEN ────────────────────── */
            .go-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 36px 32px;
                max-width: 560px;
                width: 100%;
                text-align: center;
            }
            .go-title {
                font-size: 2rem;
                font-weight: 800;
                color: var(--red);
                margin-bottom: 4px;
            }
            .go-title.win {
                color: var(--yellow);
            }
            .go-sub {
                font-size: 0.85rem;
                color: var(--text2);
                margin-bottom: 24px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 20px;
            }
            .stat {
                background: var(--bg);
                border: 1px solid var(--border2);
                border-radius: 3px;
                padding: 14px;
            }
            .stat-lbl {
                font-size: 0.65rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 2px;
            }
            .stat-val {
                font-size: 1.6rem;
                font-weight: 800;
                color: var(--text);
            }

            .new-record {
                font-size: 0.75rem;
                color: var(--yellow);
                letter-spacing: 0.1em;
                text-transform: uppercase;
                margin-bottom: 16px;
                animation: blink 1s infinite;
            }

            .missed-section {
                text-align: left;
                margin-bottom: 20px;
            }
            .missed-lbl {
                font-size: 0.68rem;
                color: var(--text3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 10px;
            }
            .missed-item {
                padding: 10px 14px;
                border-radius: 3px;
                background: var(--bg);
                border: 1px solid var(--border);
                margin-bottom: 8px;
                font-size: 0.8rem;
            }
            .missed-item .mi-name {
                font-weight: 600;
                color: var(--text);
                margin-bottom: 6px;
            }
            .missed-row {
                display: flex;
                gap: 8px;
                align-items: flex-start;
                margin-top: 4px;
            }
            .mi-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 2px 6px;
                border-radius: 2px;
                flex-shrink: 0;
                margin-top: 2px;
            }
            .mi-label.chosen {
                background: rgba(224, 82, 82, 0.15);
                border: 1px solid rgba(224, 82, 82, 0.3);
                color: var(--red);
            }
            .mi-label.correct {
                background: rgba(76, 175, 110, 0.12);
                border: 1px solid rgba(76, 175, 110, 0.3);
                color: var(--green);
            }
            .mi-label.timeout {
                background: rgba(100, 100, 100, 0.15);
                border: 1px solid var(--border);
                color: var(--text3);
            }
            .mi-val {
                flex: 1;
                line-height: 1.5;
            }

            .btn-row {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }

            /* ── RESPONSIVE ──────────────────────────── */
            @media (max-width: 600px) {
                .game-hud {
                    gap: 10px;
                }
                .game-body {
                    padding: 12px 14px 16px;
                    gap: 10px;
                }
                .question-card {
                    padding: 16px;
                }
                .options-grid {
                    gap: 8px;
                }
                .opt {
                    padding: 11px 12px;
                }
                .go-card {
                    padding: 24px 18px;
                }
                .mode-grid {
                    flex-direction: column;
                    align-items: stretch;
                    width: 100%;
                    max-width: 700px;
                }
                .mode-card {
                    width: 100%;
                    flex: none;
                    min-width: auto;
                    max-width: none;
                }
            }
        </style>
    </head>
    <body>
        <canvas id="bg"></canvas>
        <canvas id="confetti"></canvas>
        <div class="flash" id="flash"></div>
        <div class="combo-pop" id="combo-pop"></div>
        <div class="lvlup-overlay" id="lvlup-overlay">
            <div class="lvlup-text" id="lvlup-text"></div>
        </div>
        <div class="feedback" id="feedback"></div>

        <!-- ════════════════ START ════════════════ -->
        <div class="screen active" id="start-screen">
            <a href="../index.html" class="back-btn">← Back</a>
            <div class="wordmark">Device<span>Detective</span></div>

            <div class="hs-row" id="hs-row"></div>

            <div class="mode-grid">
                <div
                    class="mode-card selected"
                    data-mode="identify"
                    onclick="selectMode('identify')"
                >
                    <div class="mode-title">Identify Device</div>
                </div>
                <div
                    class="mode-card"
                    data-mode="excerpt"
                    onclick="selectMode('excerpt')"
                >
                    <div class="mode-title">Match Excerpt</div>
                </div>
                <div
                    class="mode-card"
                    data-mode="multidevice"
                    onclick="selectMode('multidevice')"
                >
                    <div class="mode-title">Multi-Device</div>
                </div>
            </div>

            <div class="filter-box">
                <div class="filter-label">Practice Topics</div>
                <div class="chips" id="chips"></div>
            </div>

            <button class="btn-primary" onclick="startGame()">PLAY</button>
        </div>

        <!-- ════════════════ GAME ════════════════ -->
        <div class="screen" id="game-screen">
            <div class="game-top">
                <div class="game-hud">
                    <div class="lives" id="lives"></div>
                    <div class="hud-group">
                        <div class="hud-lbl">Level</div>
                        <div class="hud-val c-level" id="hud-level">1</div>
                    </div>
                    <div id="streak-wrap">
                        <div class="streak-badge" id="streak-badge">×1</div>
                    </div>
                    <div class="hud-group ml-auto">
                        <div class="hud-lbl">Score</div>
                        <div class="hud-val c-score" id="hud-score">0</div>
                    </div>
                </div>
                <div class="time-track">
                    <div
                        class="time-fill"
                        id="time-fill"
                        style="width: 100%"
                    ></div>
                </div>
                <div class="xp-track">
                    <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
                </div>
                <div class="xp-lbl" id="xp-lbl">0 / 10 to next level</div>
            </div>

            <div class="game-body-wrap">
                <div class="game-body" id="game-body">
                    <div class="q-meta">
                        <div class="tag tag-mode" id="tag-mode">—</div>
                        <div class="tag tag-topic" id="tag-topic">—</div>
                        <div class="q-num" id="q-num">Q1</div>
                    </div>

                    <div class="question-card">
                        <div class="q-prompt" id="q-prompt"></div>
                        <div id="q-content"></div>
                    </div>

                    <div class="options-grid" id="opts"></div>
                    <button
                        class="submit-btn"
                        id="submit-btn"
                        onclick="submitMulti()"
                    >
                        Submit Answer
                    </button>
                </div>
            </div>
        </div>

        <!-- ════════════════ GAME OVER ════════════════ -->
        <div class="screen" id="go-screen">
            <div class="go-card">
                <div class="go-title" id="go-title">GAME OVER</div>
                <div class="go-sub" id="go-sub"></div>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-lbl">Score</div>
                        <div class="stat-val" id="go-score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-lbl">Level</div>
                        <div class="stat-val" id="go-level">1</div>
                    </div>
                    <div class="stat">
                        <div class="stat-lbl">Correct</div>
                        <div class="stat-val" id="go-correct">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-lbl">Best Streak</div>
                        <div class="stat-val" id="go-streak">0</div>
                    </div>
                </div>
                <div class="new-record" id="new-record" style="display: none">
                    ✦ NEW HIGH SCORE ✦
                </div>
                <div class="missed-section" id="missed"></div>
                <div class="btn-row">
                    <button class="btn-primary" onclick="startGame()">
                        PLAY AGAIN
                    </button>
                    <button
                        class="btn-ghost"
                        onclick="showScreen('start-screen')"
                    >
                        MENU
                    </button>
                </div>
            </div>
        </div>

        <script>
            // ═══════════════════════════════════════════════════
            //  LITERARY DEVICE DATA
            // ═══════════════════════════════════════════════════
            const DEV = [
                // ── Figurative Language ─────────────────────────
                {
                    id: "simile",
                    name: "Simile",
                    topic: "Figurative Language",
                    definition: "A comparison using 'like' or 'as'.",
                    examples: [
                        {
                            text: "Her voice was as soft as a whisper of wind through tall grass.",
                            highlight: "as soft as a whisper of wind",
                        },
                        {
                            text: "The old man moved like a ship weathering a slow, heavy storm.",
                            highlight: "like a ship weathering a slow, heavy storm",
                        },
                        {
                            text: "The city at night glittered like a circuit board alive with electricity.",
                            highlight: "like a circuit board alive with electricity",
                        },
                    ],
                },
                {
                    id: "metaphor",
                    name: "Metaphor",
                    topic: "Figurative Language",
                    definition: "A direct comparison stating one thing is another.",
                    examples: [
                        {
                            text: "Life is a journey with no map and no promised destination.",
                            highlight: "Life is a journey",
                        },
                        {
                            text: "Her words were daggers that pierced every certainty he held.",
                            highlight: "words were daggers",
                        },
                        {
                            text: "The classroom was a battlefield of clashing ideas and wounded egos.",
                            highlight: "classroom was a battlefield",
                        },
                    ],
                },
                {
                    id: "personification",
                    name: "Personification",
                    topic: "Figurative Language",
                    definition: "Giving human qualities to non-human things.",
                    examples: [
                        {
                            text: "The wind howled its grief through the skeletal branches of the oak.",
                            highlight: "wind howled its grief",
                        },
                        {
                            text: "Opportunity knocked just once and then turned away in silence.",
                            highlight: "Opportunity knocked",
                        },
                        {
                            text: "The old clock on the mantle watched each argument with patient indifference.",
                            highlight: "clock watched each argument",
                        },
                    ],
                },
                {
                    id: "hyperbole",
                    name: "Hyperbole",
                    topic: "Figurative Language",
                    definition: "Deliberate exaggeration for emphasis or effect.",
                    examples: [
                        {
                            text: "I have told you a million times to close the door behind you.",
                            highlight: "a million times",
                        },
                        {
                            text: "The suitcase weighed a thousand tonnes and threatened to pull her arm off.",
                            highlight: "weighed a thousand tonnes",
                        },
                        {
                            text: "He was so hungry he could have devoured the entire restaurant and its furniture.",
                            highlight: "devoured the entire restaurant and its furniture",
                        },
                    ],
                },
                {
                    id: "litotes",
                    name: "Litotes",
                    topic: "Figurative Language",
                    definition: "Understatement using negation of the opposite.",
                    examples: [
                        {
                            text: "Losing one's home to fire is not exactly a minor inconvenience.",
                            highlight: "not exactly a minor inconvenience",
                        },
                        {
                            text: "He was not the worst surgeon the hospital had ever employed.",
                            highlight: "not the worst surgeon",
                        },
                        {
                            text: "Running a marathon in under two hours is no small achievement.",
                            highlight: "no small achievement",
                        },
                    ],
                },
                {
                    id: "oxymoron",
                    name: "Oxymoron",
                    topic: "Figurative Language",
                    definition: "Two contradictory terms placed together for effect.",
                    examples: [
                        {
                            text: "There was a deafening silence after the verdict was read aloud.",
                            highlight: "deafening silence",
                        },
                        {
                            text: "She smiled at the bittersweet memory of their last afternoon together.",
                            highlight: "bittersweet memory",
                        },
                        {
                            text: "The documentary offered a living record of a dying tradition.",
                            highlight: "living record of a dying tradition",
                        },
                    ],
                },
                {
                    id: "paradox",
                    name: "Paradox",
                    topic: "Figurative Language",
                    definition: "A statement that seems contradictory but reveals a truth.",
                    examples: [
                        {
                            text: "The more he tried to forget her, the more vividly she appeared to him.",
                            highlight: "The more he tried to forget her, the more vividly she appeared",
                        },
                        {
                            text: "War is peace; in destroying the enemy, the nation preserved its way of life.",
                            highlight: "War is peace",
                        },
                        {
                            text: "He saved his family by abandoning them to a safer life far away.",
                            highlight: "saved his family by abandoning them",
                        },
                    ],
                },
                {
                    id: "synecdoche",
                    name: "Synecdoche",
                    topic: "Figurative Language",
                    definition: "A part represents the whole, or the whole represents a part.",
                    examples: [
                        {
                            text: "All hands on deck as the storm rolled in from the western horizon.",
                            highlight: "All hands on deck",
                        },
                        {
                            text: "The crown issued its decree without consulting the common people.",
                            highlight: "The crown",
                        },
                        {
                            text: "She needed new wheels to get to her job across the valley.",
                            highlight: "new wheels",
                        },
                    ],
                },
                {
                    id: "metonymy",
                    name: "Metonymy",
                    topic: "Figurative Language",
                    definition: "A related concept substitutes for the actual thing.",
                    examples: [
                        {
                            text: "The pen is mightier than the sword in shaping the fate of nations.",
                            highlight: "The pen is mightier than the sword",
                        },
                        {
                            text: "Hollywood has not yet come to terms with the streaming revolution.",
                            highlight: "Hollywood",
                        },
                        {
                            text: "The White House declined to comment on the leaked documents.",
                            highlight: "The White House",
                        },
                    ],
                },

                // ── Sound Devices ───────────────────────────────
                {
                    id: "alliteration",
                    name: "Alliteration",
                    topic: "Sound Devices",
                    definition: "Repetition of the same consonant sound at the start of nearby words.",
                    examples: [
                        {
                            text: "Peter Piper picked a peck of pickled peppers from the garden bed.",
                            highlight: "Peter Piper picked a peck of pickled peppers",
                        },
                        {
                            text: "The sleek, silver serpent slid silently through the summer grass.",
                            highlight: "sleek, silver serpent slid silently",
                        },
                        {
                            text: "Dark dreams drift down the deep and dangerous river at midnight.",
                            highlight: "Dark dreams drift down the deep and dangerous",
                        },
                    ],
                },
                {
                    id: "assonance",
                    name: "Assonance",
                    topic: "Sound Devices",
                    definition: "Repetition of vowel sounds in nearby words.",
                    examples: [
                        {
                            text: "The rain in Spain stays mainly on the plain.",
                            highlight: "rain in Spain stays mainly on the plain",
                        },
                        {
                            text: "Go slow over the road that flows below the old stone bridge.",
                            highlight: "slow over the road that flows below the old",
                        },
                        {
                            text: "The light of night ignites a bright and frightful sight.",
                            highlight: "light of night ignites a bright",
                        },
                    ],
                },
                {
                    id: "consonance",
                    name: "Consonance",
                    topic: "Sound Devices",
                    definition: "Repetition of consonant sounds anywhere within nearby words.",
                    examples: [
                        {
                            text: "The truck tracked through the thick dark muck all afternoon long.",
                            highlight: "truck tracked through the thick dark muck",
                        },
                        {
                            text: "Blank and frank, the plank bank stood still in the afternoon chill.",
                            highlight: "Blank and frank, the plank bank",
                        },
                        {
                            text: "He struck the black rock with a quick, slick flick of his wrist.",
                            highlight: "struck the black rock with a quick, slick flick",
                        },
                    ],
                },
                {
                    id: "onomatopoeia",
                    name: "Onomatopoeia",
                    topic: "Sound Devices",
                    definition: "A word that imitates the sound it describes.",
                    examples: [
                        {
                            text: "The bees buzzed lazily around the lavender in the afternoon heat.",
                            highlight: "buzzed",
                        },
                        {
                            text: "Rain began to pitter-patter against the thin glass of the attic window.",
                            highlight: "pitter-patter",
                        },
                        {
                            text: "The door creaked open on its rusty hinges and then slammed shut.",
                            highlight: "creaked",
                        },
                    ],
                },
                {
                    id: "sibilance",
                    name: "Sibilance",
                    topic: "Sound Devices",
                    definition: "Repetition of 's', 'sh', or 'z' sounds to create a hissing effect.",
                    examples: [
                        {
                            text: "The snake slithered swiftly, slipping through the sun-scorched sand.",
                            highlight: "snake slithered swiftly, slipping through the sun-scorched sand",
                        },
                        {
                            text: "She sells seashells so softly by the shimmering seaside shore.",
                            highlight: "sells seashells so softly by the shimmering seaside shore",
                        },
                        {
                            text: "The sea sighed and surged across the smooth stones at sunset.",
                            highlight: "sea sighed and surged across the smooth stones",
                        },
                    ],
                },

                // ── Imagery ─────────────────────────────────────
                {
                    id: "visual",
                    name: "Visual Imagery",
                    topic: "Imagery",
                    definition: "Language that appeals to the sense of sight.",
                    examples: [
                        {
                            text: "The horizon blazed crimson and gold as the last sliver of sun disappeared.",
                            highlight: "blazed crimson and gold",
                        },
                        {
                            text: "Pale moonlight fell across the cobblestones in cold, silver pools.",
                            highlight: "Pale moonlight fell across the cobblestones in cold, silver pools",
                        },
                        {
                            text: "The child's bright red coat stood out like a warning flare in the grey crowd.",
                            highlight: "bright red coat stood out like a warning flare in the grey crowd",
                        },
                    ],
                },
                {
                    id: "auditory",
                    name: "Auditory Imagery",
                    topic: "Imagery",
                    definition: "Language that appeals to the sense of hearing.",
                    examples: [
                        {
                            text: "The marketplace rang with the clash of copper pots and vendors' cries.",
                            highlight: "rang with the clash of copper pots and vendors' cries",
                        },
                        {
                            text: "A low, mournful horn echoed across the empty harbour as the ferry departed.",
                            highlight: "low, mournful horn echoed across the empty harbour",
                        },
                        {
                            text: "Somewhere beneath the floorboards, water dripped in slow, rhythmic percussion.",
                            highlight: "water dripped in slow, rhythmic percussion",
                        },
                    ],
                },
                {
                    id: "olfactory",
                    name: "Olfactory Imagery",
                    topic: "Imagery",
                    definition: "Language that appeals to the sense of smell.",
                    examples: [
                        {
                            text: "The bakery door swung open and the warm scent of cinnamon and yeast washed over her.",
                            highlight: "warm scent of cinnamon and yeast",
                        },
                        {
                            text: "Rain hit the hot pavement and released that sharp, ancient smell of wet earth.",
                            highlight: "sharp, ancient smell of wet earth",
                        },
                        {
                            text: "The hospital corridor stank of bleach and something she preferred not to name.",
                            highlight: "stank of bleach",
                        },
                    ],
                },
                {
                    id: "gustatory",
                    name: "Gustatory Imagery",
                    topic: "Imagery",
                    definition: "Language that appeals to the sense of taste.",
                    examples: [
                        {
                            text: "The medicine left a bitter, metallic taste that lingered for hours on her tongue.",
                            highlight: "bitter, metallic taste",
                        },
                        {
                            text: "Grief settled on him like the sour, brackish aftertaste of seawater.",
                            highlight: "sour, brackish aftertaste of seawater",
                        },
                        {
                            text: "She bit into the apple and sweetness exploded across her palate.",
                            highlight: "sweetness exploded across her palate",
                        },
                    ],
                },
                {
                    id: "tactile",
                    name: "Tactile Imagery",
                    topic: "Imagery",
                    definition: "Language that appeals to the sense of touch.",
                    examples: [
                        {
                            text: "The rough bark of the pine tree bit into her palms as she climbed higher.",
                            highlight: "rough bark bit into her palms",
                        },
                        {
                            text: "He pressed his face against the cool, smooth surface of the stone floor.",
                            highlight: "cool, smooth surface of the stone floor",
                        },
                        {
                            text: "The fabric scratched at her skin like a thousand tiny needles with every step.",
                            highlight: "scratched at her skin like a thousand tiny needles",
                        },
                    ],
                },
                {
                    id: "kinesthetic",
                    name: "Kinesthetic Imagery",
                    topic: "Imagery",
                    definition: "Language that conveys movement or physical sensation.",
                    examples: [
                        {
                            text: "Her stomach lurched as the lift plummeted through the dark shaft.",
                            highlight: "stomach lurched as the lift plummeted",
                        },
                        {
                            text: "The runner's legs churned beneath her, arms pumping, the finish line pulling her forward.",
                            highlight: "legs churned beneath her, arms pumping",
                        },
                        {
                            text: "The deck pitched and rolled beneath his feet as the storm intensified.",
                            highlight: "pitched and rolled beneath his feet",
                        },
                    ],
                },

                // ── Structural / Rhetorical ──────────────────────
                {
                    id: "anaphora",
                    name: "Anaphora",
                    topic: "Structural/Rhetorical",
                    definition: "Repetition of a word or phrase at the start of successive clauses.",
                    examples: [
                        {
                            text: "We shall fight on the beaches, we shall fight on the landing grounds, we shall fight in the fields.",
                            highlight: "we shall fight",
                        },
                        {
                            text: "Every voice matters. Every life matters. Every story deserves to be told and heard.",
                            highlight: "Every",
                        },
                        {
                            text: "I dreamed of a world without hunger. I dreamed of a world without fear. I dreamed.",
                            highlight: "I dreamed",
                        },
                    ],
                },
                {
                    id: "epistrophe",
                    name: "Epistrophe",
                    topic: "Structural/Rhetorical",
                    definition: "Repetition of a word or phrase at the end of successive clauses.",
                    examples: [
                        {
                            text: "Government of the people, by the people, for the people shall not perish.",
                            highlight: "the people",
                        },
                        {
                            text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.",
                            highlight: "lies",
                        },
                        {
                            text: "When I was a child, I spoke as a child, I understood as a child, I thought as a child.",
                            highlight: "as a child",
                        },
                    ],
                },
                {
                    id: "juxtaposition",
                    name: "Juxtaposition",
                    topic: "Structural/Rhetorical",
                    definition: "Placing contrasting ideas or images side by side.",
                    examples: [
                        {
                            text: "The mansion loomed over the crumbling shacks that lined the street below it.",
                            highlight: "mansion loomed over the crumbling shacks",
                        },
                        {
                            text: "It was the best of times, it was the worst of times, in that strange and fractured season.",
                            highlight: "best of times, it was the worst of times",
                        },
                        {
                            text: "The mourners laughed at the graveside while the priest wept into his Bible.",
                            highlight: "mourners laughed at the graveside while the priest wept",
                        },
                    ],
                },
                {
                    id: "antithesis",
                    name: "Antithesis",
                    topic: "Structural/Rhetorical",
                    definition: "Contrasting ideas in a balanced parallel grammatical structure.",
                    examples: [
                        {
                            text: "To err is human; to forgive, divine — this was the lesson she carried.",
                            highlight: "To err is human; to forgive, divine",
                        },
                        {
                            text: "Give every man thy ear, but few thy voice — so the old soldier had always said.",
                            highlight: "Give every man thy ear, but few thy voice",
                        },
                        {
                            text: "One small step for a man, one giant leap for mankind.",
                            highlight: "One small step for a man, one giant leap for mankind",
                        },
                    ],
                },
                {
                    id: "chiasmus",
                    name: "Chiasmus",
                    topic: "Structural/Rhetorical",
                    definition: "Reversed grammatical structure in successive clauses (A-B / B-A).",
                    examples: [
                        {
                            text: "Ask not what your country can do for you — ask what you can do for your country.",
                            highlight: "Ask not what your country can do for you — ask what you can do for your country",
                        },
                        {
                            text: "Never let a fool kiss you or a kiss fool you into believing in easy love.",
                            highlight: "never let a fool kiss you or a kiss fool you",
                        },
                        {
                            text: "You forget what you want to remember and remember what you want to forget.",
                            highlight: "forget what you want to remember and remember what you want to forget",
                        },
                    ],
                },
                {
                    id: "rhetorical",
                    name: "Rhetorical Question",
                    topic: "Structural/Rhetorical",
                    definition: "A question asked for effect, not expecting an answer.",
                    examples: [
                        {
                            text: "Is this the world we want to leave for our children — scarred and silent?",
                            highlight: "Is this the world we want to leave for our children",
                        },
                        {
                            text: "If we cannot protect the innocent, then what exactly are we protecting?",
                            highlight: "what exactly are we protecting",
                        },
                        {
                            text: "How many more must die before someone decides enough is enough?",
                            highlight: "How many more must die before someone decides enough is enough",
                        },
                    ],
                },
                {
                    id: "apostrophe",
                    name: "Apostrophe",
                    topic: "Structural/Rhetorical",
                    definition: "Direct address to an absent person, abstract idea, or inanimate object.",
                    examples: [
                        {
                            text: "O Death, where is thy sting? O grave, where is thy victory?",
                            highlight: "O Death, where is thy sting",
                        },
                        {
                            text: "Oh, cruel Fortune! Why do you smile on the wicked and frown on the just?",
                            highlight: "Oh, cruel Fortune",
                        },
                        {
                            text: "Come, sweet oblivion — let these burning memories finally dissolve.",
                            highlight: "Come, sweet oblivion",
                        },
                    ],
                },
                {
                    id: "enjambment",
                    name: "Enjambment",
                    topic: "Structural/Rhetorical",
                    definition: "A sentence continues beyond a line break without pause.",
                    examples: [
                        {
                            text: "Because I could not stop for Death — He kindly stopped for me — The carriage held but just ourselves.",
                            highlight: "could not stop for Death — He kindly stopped for me",
                        },
                        {
                            text: "I carry your heart with me (I carry it in my heart) I am never without it.",
                            highlight: "I carry your heart with me (I carry it in my heart) I am never without it",
                        },
                        {
                            text: "Whose woods these are I think I know. His house is in the village though; He will not see me stopping here.",
                            highlight: "I think I know. His house is in the village though; He will not see",
                        },
                    ],
                },

                // ── Other ────────────────────────────────────────
                {
                    id: "symbolism",
                    name: "Symbolism",
                    topic: "Other",
                    definition: "An object, person, or event that represents something beyond its literal meaning.",
                    examples: [
                        {
                            text: "The white dove settled on the broken wall, folded its wings, and was still.",
                            highlight: "white dove",
                        },
                        {
                            text: "She released the red balloon and watched it disappear into the heavy grey sky.",
                            highlight: "red balloon",
                        },
                        {
                            text: "The cracked mirror in the hallway had stared back at her family for three generations.",
                            highlight: "cracked mirror",
                        },
                    ],
                },
                {
                    id: "allusion",
                    name: "Allusion",
                    topic: "Other",
                    definition: "An indirect reference to a person, text, event, or idea.",
                    examples: [
                        {
                            text: "He met his Waterloo when the board finally voted to remove him.",
                            highlight: "met his Waterloo",
                        },
                        {
                            text: "The new software project turned out to be the developer's Achilles heel.",
                            highlight: "Achilles heel",
                        },
                        {
                            text: "She had opened a Pandora's box by asking that one small, innocent question.",
                            highlight: "Pandora's box",
                        },
                    ],
                },
                {
                    id: "foreshadowing",
                    name: "Foreshadowing",
                    topic: "Other",
                    definition: "A hint at events that will occur later in the narrative.",
                    examples: [
                        {
                            text: "He noticed the fraying rope as he passed, but did not stop to inspect it.",
                            highlight: "fraying rope",
                        },
                        {
                            text: "A raven perched on the windowsill the morning of the wedding and would not be shooed away.",
                            highlight: "raven perched on the windowsill the morning of the wedding",
                        },
                        {
                            text: "She looked back one last time at the house, wondering why she felt she would not see it again.",
                            highlight: "wondering why she felt she would not see it again",
                        },
                    ],
                },
                {
                    id: "verbal_irony",
                    name: "Verbal Irony",
                    topic: "Other",
                    definition: "Saying the opposite of what is meant.",
                    examples: [
                        {
                            text: "Oh, brilliant — another Monday morning with a broken printer and no coffee.",
                            highlight: "Oh, brilliant",
                        },
                        {
                            text: "Yes, because nothing says 'promotion' quite like being assigned the supply cupboard as an office.",
                            highlight: "nothing says 'promotion' quite like being assigned the supply cupboard",
                        },
                        {
                            text: "The judge called the defendant's plan 'perfectly sensible' before sentencing him to twenty years.",
                            highlight: "perfectly sensible",
                        },
                    ],
                },
                {
                    id: "dramatic_irony",
                    name: "Dramatic Irony",
                    topic: "Other",
                    definition: "The audience knows something a character does not.",
                    examples: [
                        {
                            text: "She smiled at the stranger who had just read every word of her diary.",
                            highlight: "smiled at the stranger who had just read every word of her diary",
                        },
                        {
                            text: "He toasted his own treachery, unaware that two detectives sat at the next table.",
                            highlight: "toasted his own treachery, unaware that two detectives sat at the next table",
                        },
                        {
                            text: "She packed her bags for the surprise party, not knowing it had been cancelled.",
                            highlight: "not knowing it had been cancelled",
                        },
                    ],
                },
                {
                    id: "situational_irony",
                    name: "Situational Irony",
                    topic: "Other",
                    definition: "When what happens is the opposite of what is expected.",
                    examples: [
                        {
                            text: "The fire station burned to the ground while the crew was out at a training exercise.",
                            highlight: "fire station burned to the ground",
                        },
                        {
                            text: "The marriage counsellor filed for divorce on the day she published her book on lasting relationships.",
                            highlight: "marriage counsellor filed for divorce",
                        },
                        {
                            text: "He had saved his entire life to travel the world but died the day before his retirement.",
                            highlight: "saved his entire life to travel the world but died the day before his retirement",
                        },
                    ],
                },
                {
                    id: "pathetic_fallacy",
                    name: "Pathetic Fallacy",
                    topic: "Other",
                    definition: "Attributing human emotions to nature or the environment.",
                    examples: [
                        {
                            text: "The sky wept the night they buried her, rain falling in long, inconsolable sheets.",
                            highlight: "sky wept the night they buried her",
                        },
                        {
                            text: "As the verdict was read, the sun retreated behind a wall of angry cloud.",
                            highlight: "sun retreated behind a wall of angry cloud",
                        },
                        {
                            text: "The cheerful daffodils nodded as he walked down the path on his wedding morning.",
                            highlight: "cheerful daffodils nodded",
                        },
                    ],
                },
                {
                    id: "euphemism",
                    name: "Euphemism",
                    topic: "Other",
                    definition: "A mild or indirect expression used in place of a blunt or harsh one.",
                    examples: [
                        {
                            text: "The company announced that it would be letting several employees go at the end of the month.",
                            highlight: "letting several employees go",
                        },
                        {
                            text: "He passed away peacefully in the early hours, surrounded by the people who loved him.",
                            highlight: "passed away",
                        },
                        {
                            text: "The minister referred to the bombing campaign as a 'targeted precision operation'.",
                            highlight: "targeted precision operation",
                        },
                    ],
                },
            ];

            // ═══════════════════════════════════════════════════
            //  BACKGROUND CANVAS
            // ═══════════════════════════════════════════════════
            const bgC = document.getElementById("bg");
            const bgX = bgC.getContext("2d");

            function resizeBg() {
                bgC.width = window.innerWidth;
                bgC.height = window.innerHeight;
                drawBg();
            }
            function drawBg() {
                bgX.clearRect(0, 0, bgC.width, bgC.height);
                const sp = 40;
                for (let x = sp / 2; x < bgC.width; x += sp)
                    for (let y = sp / 2; y < bgC.height; y += sp) {
                        bgX.beginPath();
                        bgX.arc(x, y, 1, 0, Math.PI * 2);
                        bgX.fillStyle = "rgba(255,255,255,0.05)";
                        bgX.fill();
                    }
            }

            // ═══════════════════════════════════════════════════
            //  CONFETTI
            // ═══════════════════════════════════════════════════
            const cfC = document.getElementById("confetti");
            const cfX = cfC.getContext("2d");
            let cfp = [];

            function resizeCf() {
                cfC.width = window.innerWidth;
                cfC.height = window.innerHeight;
            }

            function burst(x, y, n = 40) {
                const cols = ["#58a6ff", "#bc8cff", "#3fb950", "#d29922", "#f85149"];
                for (let i = 0; i < n; i++) {
                    const a = Math.random() * Math.PI * 2;
                    const s = 3 + Math.random() * 7;
                    cfp.push({
                        x, y,
                        vx: Math.cos(a) * s,
                        vy: Math.sin(a) * s - 3,
                        col: cols[Math.floor(Math.random() * cols.length)],
                        life: 1,
                        dec: 0.018 + Math.random() * 0.018,
                        w: 4 + Math.random() * 5,
                        h: 2 + Math.random() * 3,
                        rot: Math.random() * Math.PI,
                        rv: (Math.random() - 0.5) * 0.15,
                    });
                }
            }

            function animCf() {
                cfX.clearRect(0, 0, cfC.width, cfC.height);
                cfp = cfp.filter((p) => p.life > 0);
                cfp.forEach((p) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.25;
                    p.rot += p.rv;
                    p.life -= p.dec;
                    cfX.save();
                    cfX.translate(p.x, p.y);
                    cfX.rotate(p.rot);
                    cfX.globalAlpha = Math.max(0, p.life);
                    cfX.fillStyle = p.col;
                    cfX.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                    cfX.restore();
                });
                requestAnimationFrame(animCf);
            }

            // ═══════════════════════════════════════════════════
            //  AUDIO
            // ═══════════════════════════════════════════════════
            let _ac = null;
            function ac() {
                if (!_ac) _ac = new (window.AudioContext || window.webkitAudioContext)();
                return _ac;
            }

            function snd(type) {
                try {
                    const c = ac(), now = c.currentTime;
                    const osc = c.createOscillator(), g = c.createGain();
                    osc.connect(g);
                    g.connect(c.destination);
                    switch (type) {
                        case "ok":
                            osc.type = "sine";
                            osc.frequency.setValueAtTime(440, now);
                            osc.frequency.linearRampToValueAtTime(880, now + 0.18);
                            g.gain.setValueAtTime(0.25, now);
                            g.gain.linearRampToValueAtTime(0, now + 0.3);
                            osc.start(now); osc.stop(now + 0.3);
                            break;
                        case "no":
                            osc.type = "sawtooth";
                            osc.frequency.setValueAtTime(280, now);
                            osc.frequency.linearRampToValueAtTime(140, now + 0.22);
                            g.gain.setValueAtTime(0.18, now);
                            g.gain.linearRampToValueAtTime(0, now + 0.28);
                            osc.start(now); osc.stop(now + 0.28);
                            break;
                        case "lvl": {
                            [523, 659, 784, 1047].forEach((f, i) => {
                                const o = c.createOscillator(), g2 = c.createGain();
                                o.connect(g2); g2.connect(c.destination);
                                o.type = "sine";
                                o.frequency.setValueAtTime(f, now + i * 0.1);
                                g2.gain.setValueAtTime(0.2, now + i * 0.1);
                                g2.gain.linearRampToValueAtTime(0, now + i * 0.1 + 0.2);
                                o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.3);
                            });
                            break;
                        }
                        case "str":
                            osc.type = "triangle";
                            osc.frequency.setValueAtTime(600, now);
                            osc.frequency.linearRampToValueAtTime(900, now + 0.12);
                            g.gain.setValueAtTime(0.2, now);
                            g.gain.linearRampToValueAtTime(0, now + 0.2);
                            osc.start(now); osc.stop(now + 0.2);
                            break;
                        case "tick":
                            osc.type = "sine";
                            osc.frequency.setValueAtTime(700, now);
                            g.gain.setValueAtTime(0.04, now);
                            g.gain.linearRampToValueAtTime(0, now + 0.05);
                            osc.start(now); osc.stop(now + 0.05);
                            break;
                    }
                } catch (e) {}
            }

            // ═══════════════════════════════════════════════════
            //  GAME STATE
            // ═══════════════════════════════════════════════════
            const HS_KEYS = {
                identify: "dd_hs_identify",
                excerpt: "dd_hs_excerpt",
                multidevice: "dd_hs_multidevice",
            };

            const GS = {
                mode: "identify",
                activeTopics: new Set(),
                score: 0,
                lives: 3,
                level: 1,
                streak: 0,
                maxStreak: 0,
                correctInLevel: 0,
                totalCorrect: 0,
                totalQ: 0,
                missed: [],
                running: false,
                timeMax: 12,
                timeLeft: 12,
                timerId: null,
                answered: false,
                curDev: null,
                multiPicked: new Set(),
                correctMultiId: null,
                lastChosenName: null,
                lastCorrectName: null,
            };

            function getHS(mode) {
                return parseInt(localStorage.getItem(HS_KEYS[mode]) || "0");
            }
            function setHS(mode, val) {
                localStorage.setItem(HS_KEYS[mode], val);
            }

            // ═══════════════════════════════════════════════════
            //  TOPICS / CHIPS
            // ═══════════════════════════════════════════════════
            const TOPICS = [...new Set(DEV.map((d) => d.topic))];

            function clearChipSelection() {
                document.querySelectorAll(".chip").forEach((x) => x.classList.remove("on"));
                GS.activeTopics.clear();
            }

            function initChips() {
                const c = document.getElementById("chips");
                c.innerHTML = "";

                const all = document.createElement("div");
                all.className = "chip on";
                all.textContent = "All Topics";
                all.dataset.t = "ALL";
                all.onclick = () => {
                    clearChipSelection();
                    all.classList.add("on");
                };
                c.appendChild(all);

                TOPICS.forEach((t) => {
                    const ch = document.createElement("div");
                    ch.className = "chip";
                    ch.textContent = t;
                    ch.dataset.t = t;
                    ch.onclick = () => {
                        c.querySelector('[data-t="ALL"]').classList.remove("on");
                        GS.activeTopics.has(t)
                            ? (GS.activeTopics.delete(t), ch.classList.remove("on"))
                            : (GS.activeTopics.add(t), ch.classList.add("on"));
                        if (!GS.activeTopics.size)
                            c.querySelector('[data-t="ALL"]').classList.add("on");
                    };
                    c.appendChild(ch);
                });
            }

            function poolDevs() {
                if (!GS.activeTopics.size) return DEV;
                return DEV.filter((d) => GS.activeTopics.has(d.topic));
            }

            // ═══════════════════════════════════════════════════
            //  HIGH SCORE DISPLAY
            // ═══════════════════════════════════════════════════
            function renderHSRow() {
                const r = document.getElementById("hs-row");
                r.innerHTML = "";
                const labels = {
                    identify: "Identify Device",
                    excerpt: "Match Excerpt",
                    multidevice: "Multi-Device",
                };
                ["identify", "excerpt", "multidevice"].forEach((m) => {
                    const d = document.createElement("div");
                    d.className = "hs-card";
                    d.innerHTML = `<div class="hs-mode">${labels[m]}</div><div class="hs-val">${getHS(m).toLocaleString()}</div>`;
                    r.appendChild(d);
                });
            }

            // ═══════════════════════════════════════════════════
            //  SCREENS
            // ═══════════════════════════════════════════════════
            function showScreen(id) {
                document.querySelectorAll(".screen").forEach((s) => s.classList.remove("active"));
                document.getElementById(id).classList.add("active");
            }

            function selectMode(m) {
                GS.mode = m;
                document.querySelectorAll(".mode-card").forEach((c) =>
                    c.classList.toggle("selected", c.dataset.mode === m),
                );
            }

            // ═══════════════════════════════════════════════════
            //  START
            // ═══════════════════════════════════════════════════
            function startGame() {
                const baseTime = GS.mode === "excerpt" ? 15 : 12;
                Object.assign(GS, {
                    score: 0,
                    lives: 3,
                    level: 1,
                    streak: 0,
                    maxStreak: 0,
                    correctInLevel: 0,
                    totalCorrect: 0,
                    totalQ: 0,
                    missed: [],
                    running: true,
                    timeMax: baseTime,
                    answered: false,
                    multiPicked: new Set(),
                    correctMultiId: null,
                    lastChosenName: null,
                    lastCorrectName: null,
                });
                updateHUD();
                showScreen("game-screen");
                nextQ();
            }

            // ═══════════════════════════════════════════════════
            //  HUD
            // ═══════════════════════════════════════════════════
            function mult() {
                if (GS.streak >= 10) return 10;
                if (GS.streak >= 6) return 5;
                if (GS.streak >= 3) return 2;
                return 1;
            }

            function updateHUD() {
                const lv = document.getElementById("lives");
                lv.innerHTML = "";
                for (let i = 0; i < 3; i++) {
                    const h = document.createElement("div");
                    h.className = "heart" + (i >= GS.lives ? " lost" : "");
                    h.textContent = "♥";
                    lv.appendChild(h);
                }
                document.getElementById("hud-score").textContent = GS.score.toLocaleString();
                document.getElementById("hud-level").textContent = GS.level;
                const sb = document.getElementById("streak-badge");
                const m = mult();
                sb.textContent = `×${m}`;
                sb.className = "streak-badge" + (GS.streak >= 6 ? " fire" : "");
                document.getElementById("xp-fill").style.width = (GS.correctInLevel / 10) * 100 + "%";
                document.getElementById("xp-lbl").textContent = `${GS.correctInLevel}/10 to next level`;
            }

            // ═══════════════════════════════════════════════════
            //  QUESTIONS
            // ═══════════════════════════════════════════════════
            function nextQ() {
                if (!GS.running) return;
                stopTimer();
                GS.answered = false;
                GS.multiPicked = new Set();
                document.getElementById("submit-btn").style.display = "none";

                const pool = poolDevs();
                if (pool.length < 4) {
                    alert("Select topics with ≥4 devices.");
                    showScreen("start-screen");
                    return;
                }

                const dev = pool[Math.floor(Math.random() * pool.length)];
                GS.curDev = dev;
                GS.totalQ++;

                document.getElementById("tag-topic").textContent = dev.topic;
                document.getElementById("q-num").textContent = `Q${GS.totalQ}`;

                if (GS.mode === "identify") buildIdentify(dev, pool);
                else if (GS.mode === "excerpt") buildExcerpt(dev, pool);
                else buildMulti(dev, pool);

                startTimer();
            }

            // ── Identify Device ──────────────────────────────
            function buildIdentify(dev, pool) {
                document.getElementById("tag-mode").textContent = "Identify Device";
                const ex = dev.examples[Math.floor(Math.random() * dev.examples.length)];

                // Build highlighted excerpt
                const escapedHL = ex.highlight.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                const marked = ex.text.replace(
                    new RegExp(escapedHL),
                    `<span class="excerpt-hl">${ex.highlight}</span>`,
                );

                document.getElementById("q-prompt").textContent =
                    "What literary device is highlighted?";
                document.getElementById("q-content").innerHTML =
                    `<div class="excerpt-display">"${marked}"</div>`;

                // 4 options: device names
                const others = shuffle(pool.filter((d) => d.id !== dev.id)).slice(0, 3);
                const opts = shuffle([dev, ...others]);
                GS.lastCorrectName = dev.name;

                buildOpts(
                    opts,
                    (o) => o.id === dev.id,
                    (o) => `<span class="opt-body">${o.name}</span>`,
                    (o) => o.name,
                );
            }

            // ── Match Excerpt ────────────────────────────────
            function buildExcerpt(dev, pool) {
                document.getElementById("tag-mode").textContent = "Match Excerpt";
                document.getElementById("q-prompt").textContent =
                    "Which excerpt best demonstrates this device?";
                document.getElementById("q-content").innerHTML =
                    `<div class="device-name">${dev.name}</div>` +
                    `<div class="device-def">${dev.definition}</div>`;

                GS.lastCorrectName = dev.name;

                // Correct excerpt
                const correctEx = dev.examples[Math.floor(Math.random() * dev.examples.length)];

                // Wrong excerpts: one from each of 3 other devices
                const others = shuffle(pool.filter((d) => d.id !== dev.id)).slice(0, 3);
                const wrongExs = others.map((d) => ({
                    dev: d,
                    ex: d.examples[Math.floor(Math.random() * d.examples.length)],
                }));

                const allOpts = shuffle([
                    { isCorrect: true, dev, ex: correctEx },
                    ...wrongExs.map((w) => ({ isCorrect: false, dev: w.dev, ex: w.ex })),
                ]);

                const g = document.getElementById("opts");
                g.innerHTML = "";
                const LETTERS = ["A", "B", "C", "D"];
                allOpts.forEach((o, i) => {
                    const escapedHL = o.ex.highlight.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                    const marked = o.ex.text.replace(
                        new RegExp(escapedHL),
                        `<span class="excerpt-hl">${o.ex.highlight}</span>`,
                    );
                    const b = document.createElement("button");
                    b.className = "opt";
                    b.innerHTML =
                        `<span class="opt-letter">${LETTERS[i]}</span>` +
                        `<div class="opt-body"><span class="opt-excerpt">"${marked}"</span></div>`;
                    b.onclick = () =>
                        pickOpt(
                            b,
                            o.isCorrect,
                            () => {
                                g.querySelectorAll(".opt").forEach((btn, j) => {
                                    if (allOpts[j].isCorrect) btn.classList.add("correct");
                                });
                            },
                            o.isCorrect ? dev.name : o.dev.name,
                        );
                    g.appendChild(b);
                });
            }

            // ── Multi-Device ──────────────────────────────────
            function buildMulti(dev, pool) {
                document.getElementById("tag-mode").textContent = "Multi-Device";
                GS.correctMultiId = dev.id;
                const ex = dev.examples[Math.floor(Math.random() * dev.examples.length)];
                const escapedHL = ex.highlight.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                const marked = ex.text.replace(
                    new RegExp(escapedHL),
                    `<span class="excerpt-hl">${ex.highlight}</span>`,
                );

                document.getElementById("q-prompt").textContent =
                    "Which literary device is at work here?";
                document.getElementById("q-content").innerHTML =
                    `<div class="excerpt-display">"${marked}"</div>` +
                    `<div class="multi-hint">Select all that apply, then hit Submit.</div>`;

                GS.lastCorrectName = dev.name;

                const others = shuffle(pool.filter((d) => d.id !== dev.id)).slice(0, 3);
                const opts = shuffle([dev, ...others]);

                const g = document.getElementById("opts");
                g.innerHTML = "";
                const LETTERS = ["A", "B", "C", "D"];
                opts.forEach((d, i) => {
                    const b = document.createElement("button");
                    b.className = "opt";
                    b.dataset.id = d.id;
                    b.innerHTML =
                        `<span class="opt-letter">${LETTERS[i]}</span>` +
                        `<div class="opt-body">${d.name}</div>`;
                    b.onclick = () => toggleMultiOpt(b, d.id);
                    g.appendChild(b);
                });
                document.getElementById("submit-btn").style.display = "block";
            }

            // ── Build option buttons (identify/excerpt modes) ─
            function buildOpts(opts, isCorrect, render, getChosenName) {
                const g = document.getElementById("opts");
                g.innerHTML = "";
                const LETTERS = ["A", "B", "C", "D"];
                opts.forEach((o, i) => {
                    const b = document.createElement("button");
                    b.className = "opt";
                    b.innerHTML = `<span class="opt-letter">${LETTERS[i]}</span>${render(o)}`;
                    b.onclick = () =>
                        pickOpt(
                            b,
                            isCorrect(o),
                            () => {
                                g.querySelectorAll(".opt").forEach((btn, j) => {
                                    if (isCorrect(opts[j])) btn.classList.add("correct");
                                });
                            },
                            getChosenName ? getChosenName(o) : null,
                        );
                    g.appendChild(b);
                });
            }

            function toggleMultiOpt(btn, id) {
                if (GS.answered) return;
                GS.multiPicked.has(id)
                    ? (GS.multiPicked.delete(id), btn.classList.remove("picked"))
                    : (GS.multiPicked.add(id), btn.classList.add("picked"));
            }

            function submitMulti() {
                if (GS.answered) return;
                GS.answered = true;
                stopTimer();
                const correct = GS.multiPicked.has(GS.correctMultiId);
                const pickedId = [...GS.multiPicked][0] || null;
                if (pickedId) {
                    const pickedDev = DEV.find((d) => d.id === pickedId);
                    GS.lastChosenName = pickedDev ? pickedDev.name : null;
                } else {
                    GS.lastChosenName = null;
                }
                document.querySelectorAll("#opts .opt").forEach((btn) => {
                    btn.disabled = true;
                    if (btn.dataset.id === GS.correctMultiId) btn.classList.add("correct");
                    else if (GS.multiPicked.has(btn.dataset.id)) btn.classList.add("wrong");
                });
                resolveResult(correct);
            }

            function pickOpt(clickedBtn, isCorrect, revealFn, chosenName) {
                if (GS.answered) return;
                GS.answered = true;
                GS.lastChosenName = chosenName || null;
                stopTimer();
                document.querySelectorAll("#opts .opt").forEach((b) => (b.disabled = true));
                revealFn();
                if (!isCorrect) clickedBtn.classList.add("wrong");
                resolveResult(isCorrect);
            }

            // ═══════════════════════════════════════════════════
            //  RESULT
            // ═══════════════════════════════════════════════════
            function resolveResult(isCorrect) {
                if (isCorrect) {
                    GS.streak++;
                    GS.correctInLevel++;
                    GS.totalCorrect++;
                    if (GS.streak > GS.maxStreak) GS.maxStreak = GS.streak;

                    const m = mult();
                    const tb = Math.max(0, GS.timeLeft / GS.timeMax);
                    const pts = Math.max(10, Math.round(100 * tb * m));
                    GS.score += pts;

                    snd("ok");
                    flash("rgba(63,185,80,.08)");
                    showFeedback(`+${pts}`, "good");
                    scorePop(`+${pts}`, "#3fb950");

                    if (GS.streak === 3 || GS.streak === 6 || GS.streak === 10) {
                        comboShow();
                        snd("str");
                    }

                    if (GS.correctInLevel >= 10) {
                        GS.correctInLevel = 0;
                        GS.level++;
                        GS.timeMax = Math.max(5, GS.timeMax - 0.5);
                        lvlUpFx();
                        snd("lvl");
                    }
                } else {
                    GS.streak = 0;
                    GS.lives--;
                    if (!GS.missed.find((x) => x.dev.id === GS.curDev.id)) {
                        GS.missed.push({
                            dev: GS.curDev,
                            chosenName: GS.lastChosenName,
                            correctName: GS.lastCorrectName,
                            timedOut: false,
                            mode: GS.mode,
                        });
                    }
                    snd("no");
                    flash("rgba(248,81,73,.1)");
                    shakeScreen();
                    showFeedback("Wrong — " + GS.curDev.name, "bad");
                    if (GS.lives <= 0) {
                        updateHUD();
                        setTimeout(gameOver, 800);
                        return;
                    }
                }
                updateHUD();
                setTimeout(() => { if (GS.running) nextQ(); }, isCorrect ? 550 : 900);
            }

            // ═══════════════════════════════════════════════════
            //  TIMER
            // ═══════════════════════════════════════════════════
            function startTimer() {
                GS.timeLeft = GS.timeMax;
                renderTimerBar();
                GS.timerId = setInterval(() => {
                    GS.timeLeft -= 0.1;
                    renderTimerBar();
                    if (GS.timeLeft <= 3 && GS.timeLeft > 0 && Math.floor(GS.timeLeft * 10) % 4 === 0)
                        snd("tick");
                    if (GS.timeLeft <= 0) {
                        stopTimer();
                        if (!GS.answered) timeout();
                    }
                }, 100);
            }

            function stopTimer() {
                if (GS.timerId) {
                    clearInterval(GS.timerId);
                    GS.timerId = null;
                }
            }

            function renderTimerBar() {
                const pct = Math.max(0, (GS.timeLeft / GS.timeMax) * 100);
                const f = document.getElementById("time-fill");
                f.style.width = pct + "%";
                f.style.background =
                    pct > 50 ? "var(--green)" : pct > 25 ? "var(--yellow)" : "var(--red)";
            }

            function timeout() {
                GS.answered = true;
                GS.timeLeft = 0;
                document.querySelectorAll("#opts .opt").forEach((b) => (b.disabled = true));
                GS.streak = 0;
                GS.lives--;
                if (!GS.missed.find((x) => x.dev.id === GS.curDev.id)) {
                    GS.missed.push({
                        dev: GS.curDev,
                        chosenName: null,
                        correctName: GS.curDev.name,
                        timedOut: true,
                        mode: GS.mode,
                    });
                }
                snd("no");
                flash("rgba(248,81,73,.1)");
                shakeScreen();
                showFeedback("Time's up — " + GS.curDev.name, "bad");
                updateHUD();
                if (GS.lives <= 0) {
                    setTimeout(gameOver, 800);
                    return;
                }
                setTimeout(() => { if (GS.running) nextQ(); }, 900);
            }

            // ═══════════════════════════════════════════════════
            //  EFFECTS
            // ═══════════════════════════════════════════════════
            function flash(col) {
                const f = document.getElementById("flash");
                f.style.background = col;
                f.style.opacity = "1";
                setTimeout(() => (f.style.opacity = "0"), 180);
            }
            function shakeScreen() {
                const g = document.getElementById("game-screen");
                g.classList.remove("shaking");
                void g.offsetWidth;
                g.classList.add("shaking");
            }
            function showFeedback(msg, type) {
                const f = document.getElementById("feedback");
                f.textContent = msg;
                f.className = `feedback ${type} show`;
                setTimeout(() => f.classList.remove("show"), 1800);
            }
            function scorePop(txt, col) {
                const el = document.createElement("div");
                el.className = "score-pop";
                el.textContent = txt;
                el.style.color = col;
                el.style.left = window.innerWidth / 2 - 30 + "px";
                el.style.top = window.innerHeight / 2 - 40 + "px";
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1000);
            }
            function comboShow() {
                const m = mult();
                const labels = { 2: "Double!", 5: "Combo ×5!", 10: "Insane ×10!" };
                const cols = { 2: "#3fb950", 5: "#d29922", 10: "#db6d28" };
                const p = document.getElementById("combo-pop");
                p.textContent = (labels[m] || `×${m}`) + "  🔥";
                p.style.color = cols[m] || "#58a6ff";
                p.classList.add("show");
                burst(window.innerWidth / 2, window.innerHeight / 2, 28);
                setTimeout(() => p.classList.remove("show"), 1000);
            }
            function lvlUpFx() {
                const o = document.getElementById("lvlup-overlay");
                document.getElementById("lvlup-text").textContent = `Level ${GS.level}!`;
                o.style.opacity = "1";
                burst(window.innerWidth / 2, window.innerHeight / 3, 55);
                setTimeout(() => (o.style.opacity = "0"), 1600);
            }

            // ═══════════════════════════════════════════════════
            //  GLOBAL XP / STREAK REPORTING
            // ═══════════════════════════════════════════════════
            function reportToGlobal(score) {
                const xp = parseInt(localStorage.getItem("ibq_xp") || "0") + score;
                localStorage.setItem("ibq_xp", xp);
                const today = new Date().toISOString().slice(0, 10);
                const last = localStorage.getItem("ibq_streak_date") || "";
                const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
                let streak = parseInt(localStorage.getItem("ibq_streak_count") || "0");
                if (last === today) {
                    /* no change */
                } else if (last === yesterday) {
                    streak++;
                } else {
                    streak = 1;
                }
                localStorage.setItem("ibq_streak_date", today);
                localStorage.setItem("ibq_streak_count", streak);
            }

            // ═══════════════════════════════════════════════════
            //  GAME OVER
            // ═══════════════════════════════════════════════════
            function gameOver() {
                reportToGlobal(GS.score);
                GS.running = false;
                stopTimer();
                const prev = getHS(GS.mode);
                const isNew = GS.score > prev;
                if (isNew) setHS(GS.mode, GS.score);

                const acc = GS.totalQ > 0 ? Math.round((GS.totalCorrect / GS.totalQ) * 100) : 0;
                const t = document.getElementById("go-title");
                const s = document.getElementById("go-sub");
                if (acc >= 80) {
                    t.textContent = "Excellent!";
                    t.className = "go-title win";
                    s.textContent = `${acc}% accuracy — literature master!`;
                } else {
                    t.textContent = "Game Over";
                    t.className = "go-title";
                    s.textContent = `${acc}% accuracy — keep reading!`;
                }

                document.getElementById("go-score").textContent = GS.score.toLocaleString();
                document.getElementById("go-level").textContent = GS.level;
                document.getElementById("go-correct").textContent = GS.totalCorrect;
                document.getElementById("go-streak").textContent = GS.maxStreak;
                document.getElementById("new-record").style.display = isNew ? "block" : "none";

                const ms = document.getElementById("missed");
                ms.innerHTML = "";
                if (GS.missed.length) {
                    ms.innerHTML = '<div class="missed-lbl">Missed Questions</div>';
                    GS.missed.slice(0, 6).forEach((m) => {
                        const d = document.createElement("div");
                        d.className = "missed-item";
                        let html = `<div class="mi-name">${m.dev.name}</div>`;
                        if (m.timedOut) {
                            html += `<div class="missed-row"><span class="mi-label timeout">Timed out</span><span class="mi-val" style="color:var(--text3)">${m.dev.definition}</span></div>`;
                        } else {
                            if (m.chosenName)
                                html += `<div class="missed-row"><span class="mi-label chosen">You chose</span><span class="mi-val" style="color:var(--red)">${m.chosenName}</span></div>`;
                            html += `<div class="missed-row"><span class="mi-label correct">Correct</span><span class="mi-val" style="color:var(--green)">${m.correctName}</span></div>`;
                            html += `<div class="missed-row" style="margin-top:4px"><span style="font-size:.68rem;color:var(--text3)">${m.dev.definition}</span></div>`;
                        }
                        d.innerHTML = html;
                        ms.appendChild(d);
                    });
                }

                if (isNew) burst(window.innerWidth / 2, window.innerHeight / 4, 70);
                renderHSRow();
                showScreen("go-screen");
            }

            // ═══════════════════════════════════════════════════
            //  UTILS
            // ═══════════════════════════════════════════════════
            function shuffle(a) {
                const r = [...a];
                for (let i = r.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [r[i], r[j]] = [r[j], r[i]];
                }
                return r;
            }

            // ═══════════════════════════════════════════════════
            //  INIT
            // ═══════════════════════════════════════════════════
            function initApp() {
                resizeBg();
                resizeCf();
                initChips();
                renderHSRow();
                animCf();
                window.addEventListener("resize", () => {
                    resizeBg();
                    resizeCf();
                });
            }

            initApp();
        </script>
    </body>
</html>
